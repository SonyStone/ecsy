!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):(t=t||self,function(){var n=t.ECSY,o=t.ECSY={};e(o),o.noConflict=function(){return t.ECSY=n,o}}())}(this,(function(t){"use strict";function e(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}function n(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var o,r,i=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(o=i.next()).done;)s.push(o.value)}catch(t){r={error:t}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return s}var o=function(){function t(t,e){this.freeList=[],this.count=0,this.isObjectPool=!0;var o=null;arguments.length>1&&(o=Array.prototype.slice.call(arguments)).shift(),this.createElement=o?function(){return new(t.bind.apply(t,function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(n(arguments[e]));return t}([void 0],o)))}:function(){return new t},void 0!==e&&this.expand(e)}return t.prototype.aquire=function(){return this.freeList.length<=0&&this.expand(Math.round(.2*this.count)+1),this.freeList.pop()},t.prototype.release=function(t){t.reset&&t.reset(),this.freeList.push(t)},t.prototype.expand=function(t){for(var e=0;e<t;e++)this.freeList.push(this.createElement());this.count+=t},t.prototype.totalSize=function(){return this.count},t.prototype.totalFree=function(){return this.freeList.length},t.prototype.totalUsed=function(){return this.count-this.freeList.length},t}();function r(t){return t.name}function i(t){var e=r(t);return e.charAt(0).toLowerCase()+e.slice(1)}function s(t){var n,o,i=[];try{for(var s=e(t),a=s.next();!a.done;a=s.next()){var p=a.value;if("object"==typeof p){var u="not"===p.operator?"!":p.operator;i.push(u+r(p.Component))}else i.push(r(p))}}catch(t){n={error:t}}finally{try{a&&!a.done&&(o=s.return)&&o.call(s)}finally{if(n)throw n.error}}return i.sort().join("-")}var a=function(){function t(t){this.T=t,this.isDummyObjectPool=!0,this.count=0,this.used=0}return t.prototype.aquire=function(){return this.used++,this.count++,new this.T},t.prototype.release=function(){this.used--},t.prototype.totalSize=function(){return this.count},t.prototype.totalFree=function(){return 1/0},t.prototype.totalUsed=function(){return this.used},t}(),p=function(){function t(){this.Components={},this.componentPool={},this.numComponents={}}return t.prototype.registerComponent=function(t){this.Components[t.name]?console.warn("Component type: '"+t.name+"' already registered."):(this.Components[t.name]=t,this.numComponents[t.name]=0)},t.prototype.componentAddedToEntity=function(t){this.Components[t.name]||this.registerComponent(t),this.numComponents[t.name]++},t.prototype.componentRemovedFromEntity=function(t){this.numComponents[t.name]--},t.prototype.getComponentsPool=function(t){var e=i(t);return this.componentPool[e]||(t.prototype.reset?this.componentPool[e]=new o(t):(console.warn("Component '"+t.name+"' won't benefit from pooling because 'reset' method was not implemeneted."),this.componentPool[e]=new a(t))),this.componentPool[e]},t}(),u=function(){function t(){this.listeners={},this.stats={fired:0,handled:0}}return t.prototype.addEventListener=function(t,e){var n=this.listeners;void 0===n[t]&&(n[t]=[]),-1===n[t].indexOf(e)&&n[t].push(e)},t.prototype.hasEventListener=function(t,e){return void 0!==this.listeners[t]&&-1!==this.listeners[t].indexOf(e)},t.prototype.removeEventListener=function(t,e){var n=this.listeners[t];if(void 0!==n){var o=n.indexOf(e);-1!==o&&n.splice(o,1)}},t.prototype.dispatchEvent=function(t,n,o){var r,i;this.stats.fired++;var s=this.listeners[t];if(void 0!==s){var a=s.slice(0);try{for(var p=e(a),u=p.next();!u.done;u=p.next()){u.value.call(this,n,o)}}catch(t){r={error:t}}finally{try{u&&!u.done&&(i=p.return)&&i.call(p)}finally{if(r)throw r.error}}}},t.prototype.resetCounters=function(){this.stats.fired=this.stats.handled=0},t}(),h=function(){function t(t,n){var o,r,i=this;if(this.ENTITY_ADDED="Query#ENTITY_ADDED",this.ENTITY_REMOVED="Query#ENTITY_REMOVED",this.COMPONENT_CHANGED="Query#COMPONENT_CHANGED",this.Components=[],this.NotComponents=[],this.entities=[],this.eventDispatcher=new u,this.reactive=!1,t.forEach((function(t){"object"==typeof t?i.NotComponents.push(t.component):i.Components.push(t)})),0===this.Components.length)throw new Error("Can't create a query without components");this.key=s(t);try{for(var a=e(n.entities),p=a.next();!p.done;p=a.next()){var h=p.value;this.match(h)&&(h.queries.push(this),this.entities.push(h))}}catch(t){o={error:t}}finally{try{p&&!p.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}}return t.prototype.addEntity=function(e){e.queries.push(this),this.entities.push(e),this.eventDispatcher.dispatchEvent(t.prototype.ENTITY_ADDED,e)},t.prototype.removeEntity=function(e){var n=this.entities.indexOf(e);~n&&(this.entities.splice(n,1),n=e.queries.indexOf(this),e.queries.splice(n,1),this.eventDispatcher.dispatchEvent(t.prototype.ENTITY_REMOVED,e))},t.prototype.match=function(t){return t.hasAllComponents(this.Components)&&!t.hasAnyComponents(this.NotComponents)},t.prototype.toJSON=function(){return{key:this.key,reactive:this.reactive,components:{included:this.Components.map((function(t){return t.name})),not:this.NotComponents.map((function(t){return t.name}))},numEntities:this.entities.length}},t.prototype.stats=function(){return{numComponents:this.Components.length,numEntities:this.entities.length}},t}(),c=0,y=function(){function t(t){this.entityManager=t,this.id=c++,this.ComponentTypes=[],this.components={},this.componentsToRemove={},this.queries=[],this.ComponentTypesToRemove=[],this.alive=!1}return t.prototype.getComponent=function(t,e){var n=this.components[t.name];return n||!0!==e||(n=this.componentsToRemove[t.name]),n},t.prototype.getRemovedComponent=function(t){return this.componentsToRemove[t.name]},t.prototype.getComponents=function(){return this.components},t.prototype.getComponentsToRemove=function(){return this.componentsToRemove},t.prototype.getComponentTypes=function(){return this.ComponentTypes},t.prototype.getMutableComponent=function(t){var n,o,r=this.components[t.name];try{for(var i=e(this.queries),s=i.next();!s.done;s=i.next()){var a=s.value;a.reactive&&-1!==a.Components.indexOf(t)&&a.eventDispatcher.dispatchEvent(h.prototype.COMPONENT_CHANGED,this,r)}}catch(t){n={error:t}}finally{try{s&&!s.done&&(o=i.return)&&o.call(i)}finally{if(n)throw n.error}}return r},t.prototype.addComponent=function(t,e){return this.entityManager.entityAddComponent(this,t,e),this},t.prototype.removeComponent=function(t,e){return this.entityManager.entityRemoveComponent(this,t,e),this},t.prototype.hasComponent=function(t,e){return!!~this.ComponentTypes.indexOf(t)||!0===e&&this.hasRemovedComponent(t)},t.prototype.hasRemovedComponent=function(t){return!!~this.ComponentTypesToRemove.indexOf(t)},t.prototype.hasAllComponents=function(t){var n,o;try{for(var r=e(t),i=r.next();!i.done;i=r.next()){var s=i.value;if(!this.hasComponent(s))return!1}}catch(t){n={error:t}}finally{try{i&&!i.done&&(o=r.return)&&o.call(r)}finally{if(n)throw n.error}}return!0},t.prototype.hasAnyComponents=function(t){var n,o;try{for(var r=e(t),i=r.next();!i.done;i=r.next()){var s=i.value;if(this.hasComponent(s))return!0}}catch(t){n={error:t}}finally{try{i&&!i.done&&(o=r.return)&&o.call(r)}finally{if(n)throw n.error}}return!1},t.prototype.removeAllComponents=function(t){return this.entityManager.entityRemoveAllComponents(this,t)},t.prototype.reset=function(){this.id=c++,this.entityManager=null,this.ComponentTypes.length=0,this.queries.length=0,this.components={}},t.prototype.remove=function(t){return this.entityManager.removeEntity(this,t)},t}(),f=function(){function t(t){this.entityManager=t,this.queries={}}return t.prototype.onEntityRemoved=function(t){for(var e in this.queries)if(this.queries.hasOwnProperty(e)){var n=this.queries[e];-1!==t.queries.indexOf(n)&&n.removeEntity(t)}},t.prototype.onEntityComponentAdded=function(t,e){for(var n in this.queries)if(this.queries.hasOwnProperty(n)){var o=this.queries[n];if(~o.NotComponents.indexOf(e)&&~o.entities.indexOf(t)){o.removeEntity(t);continue}if(!~o.Components.indexOf(e)||!o.match(t)||~o.entities.indexOf(t))continue;o.addEntity(t)}},t.prototype.onEntityComponentRemoved=function(t,e){for(var n in this.queries)if(this.queries.hasOwnProperty(n)){var o=this.queries[n];if(~o.NotComponents.indexOf(e)&&!~o.entities.indexOf(t)&&o.match(t)){o.addEntity(t);continue}if(~o.Components.indexOf(e)&&~o.entities.indexOf(t)&&!o.match(t)){o.removeEntity(t);continue}}},t.prototype.getQuery=function(t){var e=s(t),n=this.queries[e];return n||(this.queries[e]=n=new h(t,this.entityManager)),n},t.prototype.stats=function(){var t={};for(var e in this.queries)this.queries.hasOwnProperty(e)&&(t[e]=this.queries[e].stats());return t},t}(),m=function(){function t(){}return t.isSystemStateComponent=!0,t}(),l=function(){function t(t){this.componentManager=t,this.entities=[],this.queryManager=new f(this),this.eventDispatcher=new u,this.entityPool=new o(y),this.entitiesWithComponentsToRemove=[],this.entitiesToRemove=[],this.deferredRemovalEnabled=!0,this.numStateComponents=0}return t.prototype.createEntity=function(){var t=this.entityPool.aquire();return t.alive=!0,t.entityManager=this,this.entities.push(t),this.eventDispatcher.dispatchEvent(v,t),t},t.prototype.entityAddComponent=function(t,e,n){if(!~t.ComponentTypes.indexOf(e)){t.ComponentTypes.push(e),e.__proto__===m&&this.numStateComponents++;var o=this.componentManager.getComponentsPool(e).aquire();if(t.components[e.name]=o,n)if(o.copy)o.copy(n);else for(var r in n)n.hasOwnProperty(r)&&(o[r]=n[r]);this.queryManager.onEntityComponentAdded(t,e),this.componentManager.componentAddedToEntity(e),this.eventDispatcher.dispatchEvent(g,t,e)}},t.prototype.entityRemoveComponent=function(t,e,n){var o=t.ComponentTypes.indexOf(e);if(~o){if(this.eventDispatcher.dispatchEvent(C,t,e),n)this._entityRemoveComponentSync(t,e,o);else{0===t.ComponentTypesToRemove.length&&this.entitiesWithComponentsToRemove.push(t),t.ComponentTypes.splice(o,1),t.ComponentTypesToRemove.push(e);var i=r(e);t.componentsToRemove[i]=t.components[i],delete t.components[i]}this.queryManager.onEntityComponentRemoved(t,e),e.__proto__===m&&(this.numStateComponents--,0!==this.numStateComponents||t.alive||t.remove())}},t.prototype._entityRemoveComponentSync=function(t,e,n){t.ComponentTypes.splice(n,1);var o=i(e),s=r(e),a=t.components[s];delete t.components[s],this.componentManager.componentPool[o].release(a),this.componentManager.componentRemovedFromEntity(e)},t.prototype.entityRemoveAllComponents=function(t,e){for(var n=t.ComponentTypes,o=n.length-1;o>=0;o--)n[o].__proto__!==m&&this.entityRemoveComponent(t,n[o],e)},t.prototype.removeEntity=function(t,e){var n=this.entities.indexOf(t);if(!~n)throw new Error("Tried to remove entity not in list");t.alive=!1,0===this.numStateComponents&&(this.eventDispatcher.dispatchEvent(d,t),this.queryManager.onEntityRemoved(t),!0===e?this._releaseEntity(t,n):this.entitiesToRemove.push(t)),this.entityRemoveAllComponents(t,e)},t.prototype._releaseEntity=function(t,e){this.entities.splice(e,1),t.entityManager=null,this.entityPool.release(t)},t.prototype.removeAllEntities=function(){for(var t=this.entities.length-1;t>=0;t--)this.removeEntity(this.entities[t])},t.prototype.processDeferredRemoval=function(){var t,n,o,s;if(this.deferredRemovalEnabled){try{for(var a=e(this.entitiesToRemove),p=a.next();!p.done;p=a.next()){var u=p.value,h=this.entities.indexOf(u);this._releaseEntity(u,h)}}catch(e){t={error:e}}finally{try{p&&!p.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}this.entitiesToRemove.length=0;try{for(var c=e(this.entitiesWithComponentsToRemove),y=c.next();!y.done;y=c.next())for(u=y.value;u.ComponentTypesToRemove.length>0;){var f=u.ComponentTypesToRemove.pop(),m=i(f),l=r(f),v=u.componentsToRemove[l];delete u.componentsToRemove[l],this.componentManager.componentPool[m].release(v),this.componentManager.componentRemovedFromEntity(f)}}catch(t){o={error:t}}finally{try{y&&!y.done&&(s=c.return)&&s.call(c)}finally{if(o)throw o.error}}this.entitiesWithComponentsToRemove.length=0}},t.prototype.queryComponents=function(t){return this.queryManager.getQuery(t)},t.prototype.count=function(){return this.entities.length},t.prototype.stats=function(){var t={numEntities:this.entities.length,numQueries:Object.keys(this.queryManager.queries).length,queries:this.queryManager.stats(),numComponentPool:Object.keys(this.componentManager.componentPool).length,componentPool:{},eventDispatcher:this.eventDispatcher.stats};for(var e in this.componentManager.componentPool)if(this.componentManager.componentPool.hasOwnProperty(e)){var n=this.componentManager.componentPool[e];t.componentPool[e]={used:n.totalUsed(),size:n.count}}return t},t}(),v="EntityManager#ENTITY_CREATE",d="EntityManager#ENTITY_REMOVED",g="EntityManager#COMPONENT_ADDED",C="EntityManager#COMPONENT_REMOVE";var E,T=function(){function t(t){this.entityManager=t,this.systems=[],this.executeSystems=[],this.lastExecutedSystem=null}return t.prototype.registerSystem=function(t,e){if(void 0!==this.systems.find((function(e){return e.constructor.name===t.name})))return console.warn("System '"+t.name+"' already registered."),this;var n=new t;if(e&&e.priority&&(n.priority=e.priority),t.queries){var o=function(e){if(t.queries.hasOwnProperty(e)){var o=t.queries[e],i=o.components;if(!i||0===i.length)throw new Error("'components' attribute can't be empty in a query");var s=r.entityManager.queryComponents(i);n.queriesOther[e]=s,!0===o.mandatory&&n.mandatoryQueries.push(s),n.queries[e]={results:s.entities};var a={added:h.prototype.ENTITY_ADDED,removed:h.prototype.ENTITY_REMOVED,changed:h.prototype.COMPONENT_CHANGED};o.listen&&["added","removed","changed"].forEach((function(t){if(o.listen[t]){var r=o.listen[t];if("changed"===t){if(s.reactive=!0,!0===r){var i=n.queries[e][t]=[];s.eventDispatcher.addEventListener(h.prototype.COMPONENT_CHANGED,(function(t){-1===i.indexOf(t)&&i.push(t)}))}else if(Array.isArray(r)){var p=n.queries[e][t]=[];s.eventDispatcher.addEventListener(h.prototype.COMPONENT_CHANGED,(function(t,e){-1!==r.indexOf(e.constructor)&&-1===p.indexOf(t)&&p.push(t)}))}}else{var u=n.queries[e][t]=[];s.eventDispatcher.addEventListener(a[t],(function(t){-1===u.indexOf(t)&&u.push(t)}))}}}))}},r=this;for(var i in t.queries)o(i)}return n.init&&n.init(),n.order=this.systems.length,this.systems.push(n),n.run&&(this.executeSystems.push(n),this.sortSystems()),this},t.prototype.sortSystems=function(){this.executeSystems.sort((function(t,e){return t.priority-e.priority||t.order-e.order}))},t.prototype.getSystem=function(t){return this.systems.find((function(e){return e instanceof t}))},t.prototype.getSystems=function(){return this.systems},t.prototype.removeSystem=function(t){var e=this.systems.indexOf(t);~e&&this.systems.splice(e,1)},t.prototype.runSystem=function(t){if(t.initialized&&function(t){var n,o;if(0===t.mandatoryQueries.length)return!0;try{for(var r=e(t.mandatoryQueries),i=r.next();!i.done;i=r.next()){if(0===i.value.entities.length)return!1}}catch(t){n={error:t}}finally{try{i&&!i.done&&(o=r.return)&&o.call(r)}finally{if(n)throw n.error}}return!0}(t)){var n=performance.now();t.run(),t.executeTime=performance.now()-n,this.lastExecutedSystem=t,function(t){for(var e in t.queries)if(t.queries.hasOwnProperty(e)){var n=t.queries[e];if(n.added&&(n.added.length=0),n.removed&&(n.removed.length=0),n.changed)if(Array.isArray(n.changed))n.changed.length=0;else for(var o in n.changed)n.changed.hasOwnProperty(o)&&(n.changed[o].length=0)}}(t)}},t.prototype.stop=function(){var t,n;try{for(var o=e(this.executeSystems),r=o.next();!r.done;r=o.next()){var i=r.value;i.stop(),i.executeTime=0}}catch(e){t={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}},t.prototype.run=function(t){var n,o;try{for(var r=e(this.executeSystems),i=r.next();!i.done;i=r.next()){var s=i.value;(t||s.enabled)&&this.runSystem(s)}}catch(t){n={error:t}}finally{try{i&&!i.done&&(o=r.return)&&o.call(r)}finally{if(n)throw n.error}}},t.prototype.stats=function(){var t,n,o={numSystems:this.systems.length,systems:{}};try{for(var r=e(this.systems),i=r.next();!i.done;i=r.next()){var s=i.value,a=o.systems[s.constructor.name]={queries:{}};for(var p in s.ctx)s.ctx.hasOwnProperty(p)&&(a.queries[p]=s.ctx[p].stats())}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return o},t}(),O=function(){function t(){if(this.componentsManager=new p,this.entityManager=new l(this.componentsManager),this.systemManager=new T(this.entityManager),this.enabled=!0,this.eventQueues={},this.lastTime=performance.now(),"undefined"!=typeof CustomEvent){var t=new CustomEvent("ecsy-world-created",{detail:{world:this}});window.dispatchEvent(t)}}return t.prototype.registerComponent=function(t){return this.componentsManager.registerComponent(t),this},t.prototype.registerSystem=function(t,e){return this.systemManager.registerSystem(t,e),this},t.prototype.getSystem=function(t){return this.systemManager.getSystem(t)},t.prototype.getSystems=function(){return this.systemManager.getSystems()},t.prototype.run=function(){this.enabled&&(this.systemManager.run(),this.entityManager.processDeferredRemoval())},t.prototype.stop=function(){this.enabled=!1},t.prototype.play=function(){this.enabled=!0},t.prototype.createEntity=function(){return this.entityManager.createEntity()},t.prototype.stats=function(){var t={entities:this.entityManager.stats(),system:this.systemManager.stats()};console.log(JSON.stringify(t,null,2))},t}(),w=function(){function t(){this.enabled=!0,this.initialized=!0,this.queriesOther={},this.queries={},this.mandatoryQueries=[]}return t.prototype.run=function(){},t.prototype.play=function(){this.enabled=!0},t.prototype.stop=function(){this.enabled=!1},t}();!function(t){t.Number="number",t.Boolean="boolean",t.String="string",t.Array="array"}(E||(E={}));var x={number:E.Number,boolean:E.Boolean,string:E.String};function M(t){return Array.isArray(t)?E.Array:x[typeof t]?x[typeof t]:null}t.Not=function(t){return{operator:"not",component:t}},t.SystemBase=w,t.Version="0.1.4",t.World=O,t.createComponentClass=function(t,e){for(var n in t){if(t.hasOwnProperty(n))(i=t[n].type)||(t[n].type=M(t[n].default))}var o=function(){for(var e in t)if(t.hasOwnProperty(e)){var n=t[e],o=n.type;o&&o.isType?this[e]=o.create(n.default):this[e]=n.default}};void 0!==e&&Object.defineProperty(o,"name",{value:e}),o.prototype.schema=t;var r=!0;for(var n in t){if(t.hasOwnProperty(n))(s=t[n]).type||(s.type=M(s.default)),(i=s.type)||(console.warn("Unknown type definition for attribute '"+n+"'"),r=!1)}if(r){for(var n in o.prototype.copy=function(e){for(var n in t)if(e[n]){var o=t[n].type;o.isSimpleType?this[n]=e[n]:o.copy?o.copy(this,e,n):console.warn("Unknown copy function for attribute '"+n+"' data type")}},o.prototype.reset=function(){for(var e in t)if(t.hasOwnProperty(e)){var n=t[e],o=n.type;o.reset&&o.reset(this,e,n.default)}},o.prototype.clear=function(){for(var e in t)if(t.hasOwnProperty(e)){var n=t[e].type;n.clear&&n.clear(this,e)}},t)if(t.hasOwnProperty(n)){var i=(s=t[n]).type;o.prototype[n]=s.default,i.reset&&i.reset(o.prototype,n,s.default)}}else for(var n in console.warn("This component can't use pooling because some data types are not registered. Please provide a type created with 'createType'"),t)if(t.hasOwnProperty(n)){var s=t[n];o.prototype[n]=s.default}return o},Object.defineProperty(t,"__esModule",{value:!0})}));
